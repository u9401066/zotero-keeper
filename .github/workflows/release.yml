name: Release

on:
  push:
    tags:
      # Only trigger for MCP server releases (v1.x.x format)
      # Extension releases use v*-ext tags and are published via VS Code Marketplace
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write  # Required for trusted publishing
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        pip install build

    - name: Build package
      working-directory: ./mcp-server
      run: |
        python -m build

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: mcp-server/dist/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: mcp-server/dist/
      # Uses trusted publishing - no API token needed!
      # Configure at: https://pypi.org/manage/project/zotero-keeper/settings/publishing/
